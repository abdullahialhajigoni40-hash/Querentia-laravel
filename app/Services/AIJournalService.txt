<?php

namespace App\Services;

use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Storage;

class AIJournalService
{
    // Public method to enhance a single section
    public function enhanceSingleSection($sectionType, $content, $journal)
    {
        // Compose prompt for section enhancement
        $prompt = "Enhance this {$sectionType} section for an academic journal. Improve clarity, academic tone, and flow:\n\n{$content}";
        $providerUsed = 'simulation';
        $enhanced = $content;
        $suggestions = [];
        if (!env('AI_SIMULATION_MODE', true)) {
            $enhanced = $this->callAIWithFallback('deepseek', $prompt, [
                'temperature' => 0.4,
                'max_tokens' => 1000,
            ]);
            $providerUsed = 'deepseek';
            $suggestions = ["Review clarity, tone, and flow for academic standards."];
        } else {
            $enhanced .= "\n\n[Enhanced with improved academic tone and clarity]";
            $suggestions = ["Simulation mode: No real AI enhancement performed."];
        }
        return [
            'enhanced_content' => $enhanced,
            'suggestions' => $suggestions,
            'provider' => $providerUsed,
        ];
    }
    private $providers;
    
    public function __construct()
    {
        // Initialize providers in constructor
        $this->providers = [
            'deepseek' => [
                'endpoint' => 'https://api.deepseek.com/chat/completions',
                'api_key' => env('DEEPSEEK_API_KEY', ''),
                'model' => 'deepseek-chat',
            ],
            'chatgpt' => [
                'endpoint' => 'https://api.openai.com/v1/chat/completions',
                'api_key' => env('OPENAI_API_KEY', ''),
                'model' => 'gpt-4',
            ],
            'gemini' => [
                'endpoint' => 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent',
                'api_key' => env('GEMINI_API_KEY', ''),
                'model' => 'gemini-pro',
            ]
        ];
    }

    // Main function to process journal
    public function processJournal(array $journalData)
    {
        Log::info('Starting AI journal processing', ['title' => $journalData['title']]);
        
        // Check if AI simulation mode is enabled
        if (env('AI_SIMULATION_MODE', true)) {
            return $this->simulateAIProcessing($journalData);
        }
        
        try {
            // Step 1: Format to academic journal structure
            $formattedContent = $this->formatToAcademicJournal($journalData);
            
            // Step 2: Enhance each section
            $enhancedContent = $this->enhanceSections($formattedContent, $journalData);
            
            // Step 3: Check for issues
            $issues = $this->checkForIssues($enhancedContent);
            
            // Step 4: Generate PDF preview
            $pdfPath = $this->generatePDFPreview($enhancedContent, $journalData['title']);
            
            return [
                'formatted_content' => $enhancedContent,
                'html_content' => $this->convertToHTML($enhancedContent),
                'pdf_path' => $pdfPath,
                'issues_found' => $issues,
                'plagiarism_risk' => 'low',
                'readiness_score' => $this->calculateReadinessScore($enhancedContent),
                'processing_time' => now(),
                'word_count' => str_word_count($enhancedContent),
            ];
        } catch (\Exception $e) {
            Log::error('AI processing failed, falling back to simulation', ['error' => $e->getMessage()]);
            return $this->simulateAIProcessing($journalData);
        }
    }

    private function formatToAcademicJournal(array $journalData): string
    {
        $template = $this->loadJournalTemplate($journalData['template'] ?? 'natural-sciences');
        
        $prompt = $this->buildFormattingPrompt($journalData, $template);
        
        return $this->callAIWithFallback('deepseek', $prompt, [
            'temperature' => 0.3,
            'max_tokens' => 4000,
        ]);
    }

    private function buildFormattingPrompt(array $journalData, string $template): string
    {
        $year = date('Y');
        $volume = rand(7, 15);
        $issue = rand(1, 12);
        
        return <<<PROMPT
You are Querentia's Academic Journal Formatter. Transform this raw research into a publication-ready manuscript.

**EXACT TEMPLATE TO FOLLOW:**
Journal of Natural Sciences Research
ISSN 2224-3186 (Paper)   ISSN 2225-0921 (Online)
Vol.{$volume}, No.{$issue}, {$year}

www.iiste.org

[Title Centered Here]

[Authors with superscript numbers]

[Affiliations list]

**Abstract**
[150-250 word summary]

**Keywords:** [comma separated]

**1.0 INTRODUCTION**
[Background, literature review, research gap]

**2.0 METHODOLOGY**
[Study design, population, data collection, analysis]

**3.0 RESULTS**
[Findings with tables/figures]

**4.0 DISCUSSION**
[Interpretation, comparison with literature]

**5.0 CONCLUSION**
[Summary, recommendations, future research]

**REFERENCES**
[APA format]

**ACKNOWLEDGEMENT**
[If applicable]

**USER CONTENT:**
TITLE: {$journalData['title']}

AUTHORS: {$this->formatAuthors($journalData['authors'] ?? '')}

ABSTRACT: {$journalData['abstract']}

INTRODUCTION: {$journalData['introduction']}

METHODOLOGY: {$journalData['methodology']}

RESULTS: {$journalData['results']}

DISCUSSION: {$journalData['discussion']}

CONCLUSION: {$journalData['conclusion']}

REFERENCES: {$journalData['references']}

**RULES:**
1. Maintain 80% original wording - ENHANCE, don't rewrite
2. Fix grammar, improve academic tone
3. Add section headers exactly as shown
4. Format tables from data provided
5. Add proper citations (Author, Year)
6. Ensure logical flow between sections
7. Add page numbers at bottom
8. Include all provided content

**OUTPUT:** Complete formatted journal manuscript ready for publication.
PROMPT;
    }

    private function callAIWithFallback(string $preferredProvider, string $prompt, array $options = []): string
    {
        $providers = ['deepseek', 'chatgpt', 'gemini'];
        
        // If simulation mode or no API keys, use simulation
        if (env('AI_SIMULATION_MODE', true)) {
            return $this->simulateAIResponse($prompt);
        }
        
        foreach ($providers as $provider) {
            try {
                if (empty($this->providers[$provider]['api_key'])) {
                    Log::warning("Skipping {$provider} - no API key");
                    continue;
                }
                
                Log::info("Trying AI provider: {$provider}");
                
                $result = $this->callSingleAI($provider, $prompt, $options);
                
                if ($result && strlen($result) > 500) {
                    Log::info("AI provider {$provider} succeeded");
                    return $result;
                }
            } catch (\Exception $e) {
                Log::error("AI provider {$provider} failed: " . $e->getMessage());
                continue;
            }
        }
        
        // If all providers fail, use simulation
        return $this->simulateAIResponse($prompt);
    }

    private function callSingleAI(string $provider, string $prompt, array $options): string
    {
        $config = $this->providers[$provider];
        
        if ($provider === 'deepseek' || $provider === 'chatgpt') {
            $response = Http::timeout(60)
                ->retry(3, 100)
                ->withHeaders([
                    'Authorization' => 'Bearer ' . $config['api_key'],
                    'Content-Type' => 'application/json',
                ])->post($config['endpoint'], [
                    'model' => $config['model'],
                    'messages' => [
                        ['role' => 'system', 'content' => 'You are an expert academic journal editor.'],
                        ['role' => 'user', 'content' => $prompt]
                    ],
                    'temperature' => $options['temperature'] ?? 0.3,
                    'max_tokens' => $options['max_tokens'] ?? 4000,
                ]);
            
            if ($response->successful()) {
                $data = $response->json();
                return $data['choices'][0]['message']['content'] ?? '';
            }
            
            throw new \Exception("API call failed: " . $response->body());
        }
        
        // Gemini
        $response = Http::timeout(60)
            ->retry(3, 100)
            ->post($config['endpoint'] . '?key=' . $config['api_key'], [
                'contents' => [
                    'parts' => [
                        ['text' => $prompt]
                    ]
                ],
                'generationConfig' => [
                    'temperature' => $options['temperature'] ?? 0.3,
                    'maxOutputTokens' => $options['max_tokens'] ?? 4000,
                ]
            ]);
        
        if ($response->successful()) {
            $data = $response->json();
            return $data['candidates'][0]['content']['parts'][0]['text'] ?? '';
        }
        
        throw new \Exception("Gemini API call failed");
    }

    private function simulateAIResponse(string $prompt): string
    {
        // Extract title from prompt for simulation
        $title = '';
        if (preg_match('/TITLE:\s*(.+)/', $prompt, $matches)) {
            $title = trim($matches[1]);
        }
        
        $year = date('Y');
        $volume = rand(7, 15);
        $issue = rand(1, 12);
        
        return <<<CONTENT
Journal of Natural Sciences Research
ISSN 2224-3186 (Paper)   ISSN 2225-0921 (Online)
Vol.{$volume}, No.{$issue}, {$year}

www.iiste.org

{$title}

John Doe^1, Jane Smith^2

1. Department of Research, University of Example
2. School of Academic Studies, Example University

**Abstract**
This study presents important findings in the field. The research demonstrates significant contributions to academic knowledge with practical implications for further investigation.

**Keywords:** research, academic, publication, study

**1.0 INTRODUCTION**
The introduction provides background context and establishes the research gap that this study addresses. Previous literature in the field is reviewed to situate the current research within existing knowledge.

**2.0 METHODOLOGY**
This study employed a rigorous research design with appropriate methodologies. Data collection procedures followed established protocols, and analysis methods were selected based on research objectives.

**3.0 RESULTS**
Findings indicate significant results that contribute to the field. Data analysis reveals important patterns and relationships that support the research hypotheses.

**4.0 DISCUSSION**
The results are discussed in relation to existing literature. Theoretical and practical implications are explored, with consideration of study limitations.

**5.0 CONCLUSION**
This research concludes with significant findings and recommendations for future study. The contributions to the field are summarized with suggestions for practical application.

**REFERENCES**
Smith, J. (2023). Academic Research Methods. Journal of Studies, 15(2), 45-67.
Johnson, L. (2022). Research Publication Trends. Academic Quarterly, 8(3), 112-125.

**ACKNOWLEDGEMENT**
The authors acknowledge the support received during this research. Special thanks to all contributors and institutions involved.
CONTENT;
    }

    private function enhanceSections(string $content, array $journalData): string
    {
        // In simulation mode, return content as-is
        if (env('AI_SIMULATION_MODE', true)) {
            return $content;
        }
        
        // Enhance specific sections
        $sectionsToEnhance = ['Abstract', 'Introduction', 'Discussion', 'Conclusion'];
        
        foreach ($sectionsToEnhance as $section) {
            $sectionContent = $this->extractSection($content, $section);
            
            if ($sectionContent) {
                $enhanced = $this->enhanceSection($section, $sectionContent);
                $content = str_replace($sectionContent, $enhanced, $content);
            }
        }
        
        return $content;
    }

    private function extractSection(string $content, string $sectionName): ?string
    {
        $pattern = "/\\*\\*" . preg_quote($sectionName) . "\\*\\*(.*?)(?=\\*\\*|$)/s";
        
        if (preg_match($pattern, $content, $matches)) {
            return trim($matches[1]);
        }
        
        // Try without ** for section headers
        $pattern2 = "/" . preg_quote($sectionName) . "\s*\n(.*?)(?=\n\n|\Z)/s";
        
        if (preg_match($pattern2, $content, $matches)) {
            return trim($matches[1]);
        }
        
        return null;
    }

    private function enhanceSection(string $sectionName, string $content): string
    {
        $prompt = "Enhance this {$sectionName} section for an academic journal. Improve clarity, academic tone, and flow:\n\n{$content}";
        
        if (env('AI_SIMULATION_MODE', true)) {
            return $content . "\n\n[Enhanced with improved academic tone and clarity]";
        }
        
        return $this->callAIWithFallback('deepseek', $prompt, [
            'temperature' => 0.4,
            'max_tokens' => 1000,
        ]);
    }

    private function generatePDFPreview(string $content, string $title): string
    {
        try {
            $pdf = \PDF::loadView('journal.pdf-template', [
                'content' => $content,
                'title' => $title,
                'date' => now()->format('Y-m-d'),
            ]);
            
            $filename = 'journals/' . \Str::slug($title) . '-' . time() . '.pdf';
            
            // Ensure journals directory exists
            Storage::makeDirectory('journals');
            
            Storage::put($filename, $pdf->output());
            
            return $filename;
        } catch (\Exception $e) {
            Log::error('PDF generation failed: ' . $e->getMessage());
            return 'journals/placeholder.pdf';
        }
    }

    private function convertToHTML(string $content): string
    {
        // Convert markdown-style formatting to HTML
        $html = nl2br(htmlspecialchars($content));
        
        // Add academic styling
        $replacements = [
            '**Abstract**' => '<h3 class="font-bold text-lg mt-6 mb-2">Abstract</h3>',
            '**Keywords:**' => '<h4 class="font-semibold mt-4 mb-2">Keywords:</h4>',
            '1.0 INTRODUCTION' => '<h2 class="font-bold text-xl mt-8 mb-4 border-b pb-2">1.0 INTRODUCTION</h2>',
            '2.0 METHODOLOGY' => '<h2 class="font-bold text-xl mt-8 mb-4 border-b pb-2">2.0 METHODOLOGY</h2>',
            '3.0 RESULTS' => '<h2 class="font-bold text-xl mt-8 mb-4 border-b pb-2">3.0 RESULTS</h2>',
            '4.0 DISCUSSION' => '<h2 class="font-bold text-xl mt-8 mb-4 border-b pb-2">4.0 DISCUSSION</h2>',
            '5.0 CONCLUSION' => '<h2 class="font-bold text-xl mt-8 mb-4 border-b pb-2">5.0 CONCLUSION</h2>',
            'REFERENCES' => '<h2 class="font-bold text-xl mt-8 mb-4 border-b pb-2">REFERENCES</h2>',
            'ACKNOWLEDGEMENT' => '<h2 class="font-bold text-xl mt-8 mb-4 border-b pb-2">ACKNOWLEDGEMENT</h2>',
        ];
        
        foreach ($replacements as $find => $replace) {
            $html = str_replace($find, $replace, $html);
        }
        
        return '<div class="journal-content font-serif text-gray-800 leading-relaxed">' . $html . '</div>';
    }

    private function checkForIssues(string $content): array
    {
        if (env('AI_SIMULATION_MODE', true)) {
            return [
                'plagiarism_risk' => 'low',
                'grammar_issues' => [],
                'missing_sections' => [],
                'suggestions' => ['Consider adding more detailed methodology section']
            ];
        }
        
        $prompt = "Analyze this academic manuscript for issues:\n\n{$content}\n\nCheck:\n1. Plagiarism risk (low/medium/high)\n2. Grammar issues\n3. Missing sections\n4. Citation problems\n5. Structural issues\n\nReturn JSON format.";
        
        try {
            $analysis = $this->callAIWithFallback('deepseek', $prompt, ['max_tokens' => 1000]);
            
            if (strpos($analysis, '{') !== false) {
                $json = substr($analysis, strpos($analysis, '{'));
                $json = substr($json, 0, strrpos($json, '}') + 1);
                
                return json_decode($json, true) ?? [];
            }
        } catch (\Exception $e) {
            Log::error('AI analysis failed: ' . $e->getMessage());
        }
        
        return [
            'plagiarism_risk' => 'unknown',
            'grammar_issues' => [],
            'missing_sections' => [],
            'suggestions' => ['Consider professional editing']
        ];
    }

    private function calculateReadinessScore(string $content): int
    {
        $score = 70; // Base score
        
        // Check for required sections
        $requiredSections = ['Abstract', 'Introduction', 'Methodology', 'Results', 'Conclusion', 'References'];
        
        foreach ($requiredSections as $section) {
            if (stripos($content, $section) !== false) {
                $score += 5;
            }
        }
        
        // Check word count
        $wordCount = str_word_count($content);
        if ($wordCount > 3000) $score += 10;
        elseif ($wordCount > 2000) $score += 5;
        
        // Check for citations
        if (preg_match('/\([A-Z][a-z]+, \d{4}\)/i', $content)) {
            $score += 10;
        }
        
        return min($score, 100);
    }

    private function formatAuthors(string $authorsText): string
    {
        if (empty($authorsText)) {
            return 'Author Name';
        }
        
        $authors = explode("\n", $authorsText);
        $formatted = [];
        
        foreach ($authors as $index => $author) {
            $parts = explode(',', $author);
            $formatted[] = trim($parts[0]) . '^' . ($index + 1);
        }
        
        return implode(', ', $formatted);
    }

    private function loadJournalTemplate(string $template): string
    {
        $templates = [
            'natural-sciences' => 'Journal of Natural Sciences Research',
            'medical' => 'Journal of Medical Research',
            'engineering' => 'Engineering Research Journal',
            'social-sciences' => 'Social Sciences Research Journal',
        ];
        
        return $templates[$template] ?? 'Journal of Natural Sciences Research';
    }

    private function simulateAIProcessing(array $journalData): array
    {
        // Simulate processing delay
        sleep(2);
        
        $template = $this->loadJournalTemplate($journalData['template'] ?? 'natural-sciences');
        
        $formattedContent = $this->generateSimulatedContent($journalData, $template);
        
        return [
            'formatted_content' => $formattedContent,
            'html_content' => $this->convertToHTML($formattedContent),
            'pdf_path' => 'journals/simulated.pdf',
            'issues_found' => [
                'plagiarism_risk' => 'low',
                'grammar_issues' => [],
                'missing_sections' => [],
                'suggestions' => ['Add more detailed results section']
            ],
            'plagiarism_risk' => 'low',
            'readiness_score' => 85,
            'processing_time' => now(),
            'word_count' => str_word_count($formattedContent),
        ];
    }

    private function generateSimulatedContent(array $journalData, string $template): string
    {
        $year = date('Y');
        $volume = rand(7, 15);
        $issue = rand(1, 12);
        
        // Extract actual content from user input
        $title = $journalData['title'] ?? 'Research Study';
        $authors = $this->formatAuthors($journalData['authors'] ?? 'Researcher Name');
        $abstract = $journalData['abstract'] ?? 'This study investigates important research questions in the field.';
        $introduction = $journalData['introduction'] ?? 'The introduction provides context and background for this research.';
        $methodology = $journalData['methodology'] ?? 'The methodology section describes the research approach and procedures.';
        $results = $journalData['results'] ?? 'Results indicate significant findings that contribute to knowledge.';
        $discussion = $journalData['discussion'] ?? 'Discussion interprets findings in relation to existing literature.';
        $conclusion = $journalData['conclusion'] ?? 'Conclusion summarizes key findings and implications.';
        $references = $journalData['references'] ?? "Smith, J. (2023). Recent Advances. Journal of Research, 15(2), 45-67.";
        
        return <<<CONTENT
{$template}
ISSN 2224-3186 (Paper)   ISSN 2225-0921 (Online)
Vol.{$volume}, No.{$issue}, {$year}

www.iiste.org

{$title}

{$authors}

**Abstract**
{$abstract}

**Keywords:** research, academic, publication

**1.0 INTRODUCTION**
{$introduction}

**2.0 METHODOLOGY**
{$methodology}

**3.0 RESULTS**
{$results}

**4.0 DISCUSSION**
{$discussion}

**5.0 CONCLUSION**
{$conclusion}

**REFERENCES**
{$references}

**ACKNOWLEDGEMENT**
The authors thank Querentia AI for assistance in manuscript preparation.
CONTENT;
    }
}